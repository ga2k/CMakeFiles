
include(CMakeFindDependencyMacro)

# Provide a wxWidgets shim for consumers.
# GfxTarget.cmake exports Core::wxWidgets that links to wx::wxmono, but consumers may not have
# wxWidgets' own CMake package (and thus no wx::wxmono target). We stage the real binaries, so we
# create an imported target that points at them *when they exist*.
#
# IMPORTANT: In superbuild flows, find_package(Gfx) may happen before staging has copied wx binaries
# into the prefix. In that case, we must NOT fail at configure time.

set(_wx_bin_dir "${PACKAGE_PREFIX_DIR}/${CMAKE_INSTALL_BINDIR}")
set(_wx_lib_dir "${PACKAGE_PREFIX_DIR}/${CMAKE_INSTALL_LIBDIR}")
set(_wx_inc_dir "${PACKAGE_PREFIX_DIR}/${CMAKE_INSTALL_INCLUDEDIR}")

file(GLOB_RECURSE SETUP_H LIST_DIRECTORIES false "${_wx_lib_dir}/wx/include/*/wx/setup.h")
list(LENGTH SETUP_H howMany)
if (howMany GREATER 1)
    list(GET SETUP_H 0 SETUP_H)
endif ()
get_filename_component(WX_DIR "${SETUP_H}" DIRECTORY)

if (EXISTS "${SETUP_H}")
    if (WIN32)
        if (NOT "@PACKAGE_FIND_QUIETLY@" STREQUAL "ON")
            message(STATUS "Copying setup.h from ${WX_DIR}")
            message(STATUS "                  to ${_wx_lib_dir}/wx/vc_x64_dll/mswud/wx")
            message(" ")
        endif ()
        file(MAKE_DIRECTORY "${_wx_lib_dir}/wx/vc_x64_dll/mswud/wx")
        file(COPY "${SETUP_H}" DESTINATION "${_wx_lib_dir}/wx/vc_x64_dll/mswud/wx")

        # Find the CMake-style generated setup.h:
        #   <prefix>/lib/wx/include/<cfg>/wx/setup.h
        file(GLOB _wx_setup_h_candidates "${_wx_lib_dir}/wx/include/*/wx/setup.h")
        list(REMOVE_DUPLICATES _wx_setup_h_candidates)

        set(_wx_setup_include_dir "")
        list(LENGTH _wx_setup_h_candidates _wx_setup_h_count)
        if (_wx_setup_h_count GREATER 0)
            list(SORT _wx_setup_h_candidates)
            list(GET _wx_setup_h_candidates 0 _wx_setup_h)
            get_filename_component(_wx_setup_include_dir "${_wx_setup_h}" DIRECTORY) # .../wx
            get_filename_component(_wx_setup_include_dir "${_wx_setup_include_dir}" DIRECTORY) # .../<cfg>
        endif ()
    else ()
        if (NOT "@PACKAGE_FIND_QUIETLY@" STREQUAL "ON")
            message(STATUS "Copying setup.h from ${WX_DIR}")
            message(STATUS "                  to ${_wx_inc_dir}/wx")
            message(" ")
        endif ()
        file(MAKE_DIRECTORY "${_wx_inc_dir}/wx")
        file(COPY "${SETUP_H}" DESTINATION "${_wx_inc_dir}/wx")

    endif ()
else ()
    message(STATUS "${SETUP_H} doesn't exist yet")
endif ()

if (WIN32)
    # Create shim only if missing.
    if (NOT TARGET wx::wxmono)
        file(GLOB _wx_dll_candidates
                "${_wx_bin_dir}/wxmsw*u*.dll"
                "${_wx_bin_dir}/wxmsw*.dll"
        )
        list(REMOVE_DUPLICATES _wx_dll_candidates)

        file(GLOB _wx_implib_candidates
                "${_wx_lib_dir}/wx_mswu-*.lib"
                "${_wx_lib_dir}/wxmswu*.lib"
        )
        list(REMOVE_DUPLICATES _wx_implib_candidates)

        list(LENGTH _wx_dll_candidates _wx_dll_count)
        list(LENGTH _wx_implib_candidates _wx_implib_count)

        if (_wx_dll_count EQUAL 1 AND _wx_implib_count EQUAL 1)
            list(GET _wx_dll_candidates 0 _wx_mono_dll)
            list(GET _wx_implib_candidates 0 _wx_mono_implib)

            add_library(wx::wxmono SHARED IMPORTED)
            set_target_properties(wx::wxmono PROPERTIES
                    IMPORTED_LOCATION "${_wx_mono_dll}"
                    IMPORTED_IMPLIB "${_wx_mono_implib}"
            )
        else ()
            if (NOT "@PACKAGE_FIND_QUIETLY@" STREQUAL "ON")
                message(STATUS
                        "Gfx package: wx::wxmono shim not created (yet).\n"
                        "bin: ${_wx_bin_dir}\n"
                        "dll candidates: ${_wx_dll_candidates}\n"
                        "lib: ${_wx_lib_dir}\n"
                        "implib candidates: ${_wx_implib_candidates}")
            endif ()
        endif ()
    endif ()

    # Patch include order even if wx::wxmono already existed.
    if (TARGET wx::wxmono AND _wx_setup_include_dir)
        get_target_property(_old_incs wx::wxmono INTERFACE_INCLUDE_DIRECTORIES)
        if (NOT _old_incs)
            set(_old_incs "")
        endif ()

        # Put the CMake-generated setup.h include dir FIRST.
        set_target_properties(wx::wxmono PROPERTIES
                INTERFACE_INCLUDE_DIRECTORIES "${_wx_setup_include_dir};${PACKAGE_PREFIX_DIR}/include;${_old_incs}"
        )

        unset(_old_incs)
    endif ()

    unset(_wx_bin_dir)
    unset(_wx_lib_dir)
    unset(_wx_setup_h_candidates)
    unset(_wx_setup_h_count)
    unset(_wx_setup_h)
    unset(_wx_setup_include_dir)
endif ()

# --------------------------------------------------------------------------------------
# Non-Windows shim:
#   - If wxWidgets' own package is present, prefer its canonical monolithic target (wx::wxwidgets)
#     and provide wx::wxmono as a compatibility alias/wrapper.
#   - Otherwise, create an IMPORTED SHARED target that points at the staged libwx_*.so.
# --------------------------------------------------------------------------------------
if (UNIX AND NOT APPLE)

    # wxWidgets Qt port needs Qt headers/libs for consumers too.
    # Export that dependency here so the include dirs (QApplication, QPalette, ...) propagate.
    if (NOT TARGET Qt6::Widgets)
        find_dependency(Qt6 REQUIRED COMPONENTS Core Gui Widgets)
    endif ()

    if (TARGET wx::wxwidgets AND NOT TARGET wx::wxmono)
        add_library(wx::wxmono INTERFACE IMPORTED)
        set_target_properties(wx::wxmono PROPERTIES
                INTERFACE_LINK_LIBRARIES "wx::wxwidgets;Qt6::Core;Qt6::Gui;Qt6::Widgets"
        )
    endif ()

    if (NOT TARGET wx::wxmono)
        file(GLOB _wx_so_candidates
                "${_wx_lib_dir}/libwx_qtu-*.so"
                "${_wx_lib_dir}/libwx_qtu-*.so.*"
                "${_wx_lib_dir}/libwx_gtk*-*.so"
                "${_wx_lib_dir}/libwx_gtk*-*.so.*"
        )
        list(REMOVE_DUPLICATES _wx_so_candidates)

        if (_wx_so_candidates)
            list(SORT _wx_so_candidates)
            set(_wx_mono_so "")
            foreach (_c IN LISTS _wx_so_candidates)
                if (_c MATCHES "\\.so$")
                    set(_wx_mono_so "${_c}")
                    break()
                endif ()
            endforeach ()
            if (NOT _wx_mono_so)
                list(GET _wx_so_candidates 0 _wx_mono_so)
            endif ()

            add_library(wx::wxmono SHARED IMPORTED)
            set_target_properties(wx::wxmono PROPERTIES
                    IMPORTED_LOCATION "${_wx_mono_so}"
                    INTERFACE_LINK_LIBRARIES "Qt6::Core;Qt6::Gui;Qt6::Widgets"
            )
        endif ()
    endif ()

    unset(_wx_so_candidates)
    unset(_wx_mono_so)
    unset(_wx_lib_dir)
endif ()
